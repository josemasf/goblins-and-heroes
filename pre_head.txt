import { Scene } from 'phaser';

export class Preloader extends Scene
{
    constructor ()

    {
        super('Preloader');
    }

    init ()

    {
        //  We loaded this image in our Boot Scene, so we can display it here
        this.add.image(512, 384, 'background');

        //  A simple progress bar. This is the outline of the bar.
        this.add.rectangle(512, 384, 468, 32).setStrokeStyle(1, 0xffffff);

        //  This is the progress bar itself. It will increase in size from the left based on the % of progress.
        const bar = this.add.rectangle(512-230, 384, 4, 28, 0xffffff);

        //  Use the 'progress' event emitted by the LoaderPlugin to update the loading bar
        this.load.on('progress', (progress: number) => {

            //  Update the progress bar (our bar is 464px wide, so 100% = 464px)
            bar.width = 4 + (460 * progress);

        });
    }

    preload ()
    {
        //  Load the assets for the game - Replace with your own assets
        //  Primero: AUDIO CONFIG
        this.load.setPath('assets/audio');
        this.load.json('music_config', 'music_config.json');

        //  Luego: volver a assets para el resto de gráficos
        this.load.setPath('assets');

        // Nota: eliminamos logo/star de assets (no existen en /public/assets)
        // Generaremos una textura 'star' procedural abajo para compatibilidad con App.vue
        this.load.image('intro', 'intro.png');

        // Fondos parallax (pack gótico)
        // ESCENA 1 - Pasillo de castillo
        this.load.image('s1_bg', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_bg.png');
        this.load.image('s1_mid', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_mid.png');
        this.load.image('s1_arches', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_arches.png');
        this.load.image('s1_lights', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_lights.png');
        this.load.image('s1_fog', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_fog.png');
        this.load.image('s1_fg', 'parallax_dungeon_pack/scene1_castle_corridor/scene1_castle_corridor_fg.png');

        // ESCENA 2 - Cripta
        this.load.image('s2_bg', 'parallax_dungeon_pack/scene2_crypt/scene2_crypt_bg.png');
        this.load.image('s2_mid', 'parallax_dungeon_pack/scene2_crypt/scene2_crypt_mid.png');
        this.load.image('s2_coffins', 'parallax_dungeon_pack/scene2_crypt/scene2_crypt_coffins.png');
        this.load.image('s2_lights', 'parallax_dungeon_pack/scene2_crypt/scene2_crypt_lights.png');
        this.load.image('s2_fog', 'parallax_dungeon_pack/scene2_crypt/scene2_crypt_fog.png');

        // ESCENA 3 - Ruinas con lava
        this.load.image('s3_bg', 'parallax_dungeon_pack/scene3_lava_ruins/scene3_lava_ruins_bg.png');
        this.load.image('s3_mid', 'parallax_dungeon_pack/scene3_lava_ruins/scene3_lava_ruins_mid.png');
        this.load.image('s3_lava', 'parallax_dungeon_pack/scene3_lava_ruins/scene3_lava_ruins_lava.png');
        this.load.image('s3_fog', 'parallax_dungeon_pack/scene3_lava_ruins/scene3_lava_ruins_fog.png');

        // ESCENA 4 - Sala del trono
        this.load.image('s4_bg', 'parallax_dungeon_pack/scene4_throne_room/scene4_throne_room_bg.png');
        this.load.image('s4_mid', 'parallax_dungeon_pack/scene4_throne_room/scene4_throne_room_mid.png');
        this.load.image('s4_arches', 'parallax_dungeon_pack/scene4_throne_room/scene4_throne_room_arches.png');
        this.load.image('s4_banners', 'parallax_dungeon_pack/scene4_throne_room/scene4_throne_room_banners.png');
        this.load.image('s4_lights', 'parallax_dungeon_pack/scene4_throne_room/scene4_throne_room_lights.png');

        // ESCENA 5 - Cámara de cristales
        this.load.image('s5_bg', 'parallax_dungeon_pack/scene5_crystal_chamber/scene5_crystal_chamber_bg.png');
        this.load.image('s5_mid', 'parallax_dungeon_pack/scene5_crystal_chamber/scene5_crystal_chamber_mid.png');
        this.load.image('s5_crystals', 'parallax_dungeon_pack/scene5_crystal_chamber/scene5_crystal_chamber_crystals.png');
        this.load.image('s5_fog', 'parallax_dungeon_pack/scene5_crystal_chamber/scene5_crystal_chamber_fog.png');
        this.load.image('s5_fg', 'parallax_dungeon_pack/scene5_crystal_chamber/scene5_crystal_chamber_fg.png');
        
        // Cargar spritesheets de héroes
        this.load.spritesheet('hero_speed_sheet', 'hero_speed_sheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('hero_jump_sheet', 'hero_jump_sheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('hero_tank_sheet', 'hero_tank_sheet.png', { frameWidth: 32, frameHeight: 32 });

        // Cargar spritesheets de enemigos y jefe
        this.load.spritesheet('goblin_green_sheet', 'goblin_green_sheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('goblin_red_sheet', 'goblin_red_sheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('boss_troll_sheet', 'boss_troll_sheet.png', { frameWidth: 64, frameHeight: 64 });

        // Cargar spritesheets de monedas y power-ups
        // Formato unificado: 8×3 grid de 32×32 por celda = 256×96 total
        // 8 frames de animación en la primera fila (frames 0-7)
        // Las filas 2 y 3 están transparentes (frames 8-23)
        
        this.load.spritesheet('coin_sheet', 'coin_sheet_like_hero.png', { 
            frameWidth: 32, 
            frameHeight: 32 
        });
        
        this.load.spritesheet('pu_life_sheet', 'pu_life_sheet_like_hero.png', { 
            frameWidth: 32, 
            frameHeight: 32 
        });
        
        this.load.spritesheet('pu_speed_sheet', 'pu_speed_sheet_like_hero.png', { 
            frameWidth: 32, 
            frameHeight: 32 
        });
        
        this.load.spritesheet('pu_inv_sheet', 'pu_inv_sheet_like_hero.png', { 
            frameWidth: 32, 
            frameHeight: 32 
        });

        // Event listener para verificar carga exitosa
        this.load.on('filecomplete', (key: string) => {
            if (key.includes('coin_sheet') || key.includes('pu_')) {
                console.log(`✅ Cargado: ${key}`);
                const tex = this.textures.get(key);
                if (tex) {
                    console.log(`   Dimensiones: ${tex.source[0].width}x${tex.source[0].height}`);
                }
            }
        });
        
        // Crear sprites proceduralmente para el juego de plataformas (player/platform/enemy/doors)
        this.createPlayerSprite();
        this.createPlatformSprite();
        this.createEnemySprite();
        // Sprite 'star' para compatibilidad con App.vue
        this.createStarSprite();
        // Monedas y power-ups vendrán de spritesheets — no generamos aquí
        this.createDoorAndBossSprites();
    }

    createPlayerSprite()

    {
        // Crear un sprite del jugador (cuadrado azul)
        const graphics = this.add.graphics();
        graphics.fillStyle(0x3498db);
        graphics.fillRect(0, 0, 32, 32);
        graphics.generateTexture('player', 32, 32);
        graphics.destroy();
    }

    createPlatformSprite()

    {
        // Crear sprite de plataforma (rectángulo marrón)
        const graphics = this.add.graphics();
        graphics.fillStyle(0x8B4513);
        graphics.fillRect(0, 0, 100, 20);
        graphics.generateTexture('platform', 100, 20);
        graphics.destroy();
    }

    createEnemySprite()

    {
        // Crear sprite de enemigo (círculo rojo)
        const graphics = this.add.graphics();
        graphics.fillStyle(0xe74c3c);
        graphics.fillCircle(16, 16, 16);
        graphics.generateTexture('enemy', 32, 32);
        graphics.destroy();
    }

    createCoinSprite() { /* no-op, usamos spritesheet */ }
    createPowerUpSprites() { /* no-op, usamos spritesheet */ }

    createDoorAndBossSprites()

    {
        // Puerta (marrón con marco claro)
        let g = this.add.graphics();
        g.fillStyle(0x8B4513);
        g.fillRect(0, 0, 32, 48);
        g.lineStyle(3, 0xdeb887);
        g.strokeRect(0, 0, 32, 48);
        g.fillStyle(0x3e2723); g.fillRect(10, 20, 12, 12); // pomo
        g.generateTexture('door', 32, 48);
        g.destroy();

        // Proyectil (orbe morado)
        g = this.add.graphics();
        g.fillStyle(0x8e44ad); g.fillCircle(6, 6, 6);
        g.lineStyle(2, 0xffffff); g.strokeCircle(6, 6, 6);
        g.generateTexture('projectile', 12, 12);
        g.destroy();

        // Jefe (enemigo grande)
        g = this.add.graphics();
        g.fillStyle(0xc0392b);
        g.fillCircle(32, 32, 32);
        g.lineStyle(4, 0x000000); g.strokeCircle(32, 32, 32);
        g.generateTexture('boss', 64, 64);
        g.destroy();

        // Glow de puerta (círculo amarillo con alpha)
        g = this.add.graphics();
        for (let r = 44; r >= 16; r -= 8) {
            const alpha = (r - 12) / 44 * 0.25;
            g.fillStyle(0xfff176, alpha);
            g.fillCircle(48, 48, r);
        }
        g.generateTexture('door_glow', 96, 96);
        g.destroy();

        // Flecha guía (triángulo)
        g = this.add.graphics();
        g.fillStyle(0xffff00, 1);
        g.fillTriangle(12, 24, 24, 24, 18, 8);
        g.lineStyle(2, 0x000000, 0.8);
        g.strokeTriangle(12, 24, 24, 24, 18, 8);
        g.generateTexture('door_arrow', 36, 32);
        g.destroy();
    }

    createHeroSprites()

    {
        // Función eliminada - ahora usamos spritesheets desde assets
    }

    createStarSprite()
    {
        // Estrella amarilla sencilla (32x32)
        const g = this.add.graphics();
        g.clear();
        g.fillStyle(0xffd54f, 1);
        const cx = 16, cy = 16, R = 14, r = 6;
        const pts: { x: number, y: number }[] = [];
        for (let i = 0; i < 10; i++) {
            const ang = (Math.PI * 2 * i) / 10 - Math.PI / 2;
            const rad = (i % 2 === 0) ? R : r;
            pts.push({ x: cx + Math.cos(ang) * rad, y: cy + Math.sin(ang) * rad });
        }
        g.beginPath();
        g.moveTo(pts[0].x, pts[0].y);
        for (let i = 1; i < pts.length; i++) g.lineTo(pts[i].x, pts[i].y);
        g.closePath();
        g.fillPath();
        g.lineStyle(2, 0xfff8e1, 1);
        g.strokePath();
        g.generateTexture('star', 32, 32);
        g.destroy();
    }\n\n    create ()\n    {
        // Definir animaciones para cada héroe desde las spritesheets
        
        // SPEED
        this.anims.create({ key: 'idle_speed', frames: this.anims.generateFrameNumbers('hero_speed_sheet', { start: 0, end: 3 }), frameRate: 6, repeat: -1 });
        this.anims.create({ key: 'walk_speed', frames: this.anims.generateFrameNumbers('hero_speed_sheet', { start: 4, end: 9 }), frameRate: 12, repeat: -1 });
        this.anims.create({ key: 'jump_speed', frames: this.anims.generateFrameNumbers('hero_speed_sheet', { start: 10, end: 12 }), frameRate: 8, repeat: 0 });
        this.anims.create({ key: 'pick_speed', frames: this.anims.generateFrameNumbers('hero_speed_sheet', { start: 13, end: 16 }), frameRate: 10, repeat: 0 });

        // JUMP
        this.anims.create({ key: 'idle_jump', frames: this.anims.generateFrameNumbers('hero_jump_sheet', { start: 0, end: 3 }), frameRate: 6, repeat: -1 });
        this.anims.create({ key: 'walk_jump', frames: this.anims.generateFrameNumbers('hero_jump_sheet', { start: 4, end: 9 }), frameRate: 12, repeat: -1 });
        this.anims.create({ key: 'jump_jump', frames: this.anims.generateFrameNumbers('hero_jump_sheet', { start: 10, end: 12 }), frameRate: 8, repeat: 0 });
        this.anims.create({ key: 'pick_jump', frames: this.anims.generateFrameNumbers('hero_jump_sheet', { start: 13, end: 16 }), frameRate: 10, repeat: 0 });

        // TANK
        this.anims.create({ key: 'idle_tank', frames: this.anims.generateFrameNumbers('hero_tank_sheet', { start: 0, end: 3 }), frameRate: 5, repeat: -1 });
        this.anims.create({ key: 'walk_tank', frames: this.anims.generateFrameNumbers('hero_tank_sheet', { start: 4, end: 9 }), frameRate: 10, repeat: -1 });
        this.anims.create({ key: 'jump_tank', frames: this.anims.generateFrameNumbers('hero_tank_sheet', { start: 10, end: 12 }), frameRate: 6, repeat: 0 });
        this.anims.create({ key: 'pick_tank', frames: this.anims.generateFrameNumbers('hero_tank_sheet', { start: 13, end: 16 }), frameRate: 8, repeat: 0 });

        // GOBLINS (verde y rojo comparten animaciones)
        this.anims.create({ key: 'goblin_idle', frames: this.anims.generateFrameNumbers('goblin_green_sheet', { start: 0, end: 3 }), frameRate: 6, repeat: -1 });
        this.anims.create({ key: 'goblin_run', frames: this.anims.generateFrameNumbers('goblin_green_sheet', { start: 4, end: 9 }), frameRate: 10, repeat: -1 });
        this.anims.create({ key: 'goblin_atk', frames: this.anims.generateFrameNumbers('goblin_green_sheet', { start: 10, end: 12 }), frameRate: 8, repeat: 0 });
        this.anims.create({ key: 'goblin_hit', frames: this.anims.generateFrameNumbers('goblin_green_sheet', { start: 13, end: 16 }), frameRate: 10, repeat: 0 });

        // TROLL (jefe)
        this.anims.create({ key: 'troll_idle', frames: this.anims.generateFrameNumbers('boss_troll_sheet', { start: 0, end: 3 }), frameRate: 5, repeat: -1 });
        this.anims.create({ key: 'troll_run', frames: this.anims.generateFrameNumbers('boss_troll_sheet', { start: 4, end: 9 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'troll_cast', frames: this.anims.generateFrameNumbers('boss_troll_sheet', { start: 10, end: 12 }), frameRate: 8, repeat: 0 });
